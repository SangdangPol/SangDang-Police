import React, { useState, useEffect } from 'react';
import { Shield, ArrowLeft, SquarePlus, Settings, Lightbulb, MessageSquare, Eye, Save, Trash2, Copy, CheckCircle2, X, Smartphone, Monitor } from 'lucide-react';

const CryptoJS = require('crypto-js');

// --- 보안 설정 영역 ---
const _v_0x2 = "P0L_MGR_S3CR3T_K3Y_2024_SANGDANG";
const _m_sec = {
  enc: (t) => t ? CryptoJS.AES.encrypt(t, _v_0x2).toString() : "",
  dec: (t) => {
    if (!t) return "";
    try {
      const bytes = CryptoJS.AES.decrypt(t, _v_0x2);
      return bytes.toString(CryptoJS.enc.Utf8);
    } catch (e) { return ""; }
  }
};

const App = () => {
  // --- 상태 관리 ---
  const [storeName, setStoreName] = useState("");
  const [address, setAddress] = useState("");
  const [guardianPhone, setGuardianPhone] = useState("");
  const [logs, setLogs] = useState([]);
  const [checklist, setChecklist] = useState([]);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [isGuideOpen, setIsGuideOpen] = useState(false);
  const [currentTraits, setCurrentTraits] = useState([]);
  const [currentDate, setCurrentDate] = useState("");
  const [guideTab, setGuideTab] = useState('android');

  const CHECKLIST_ITEMS = [
    "출입문 시정장치 및 경보음 작동 확인",
    "CCTV 녹화 상태 및 카메라 각도 점검",
    "현금·귀금속 시재 금고 보관 및 잠금 확인",
    "가게 내·외부 사각지대 확인",
    "가스/전기 차단 및 소등 확인"
  ];

  // --- 초기 로드 및 복호화 ---
  useEffect(() => {
    const now = new Date();
    setCurrentDate(now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }));

    const savedName = _m_sec.dec(localStorage.getItem('pol_storeName'));
    const savedAddr = _m_sec.dec(localStorage.getItem('pol_address'));
    const savedPhone = _m_sec.dec(localStorage.getItem('pol_guardianPhone'));
    const savedLogs = _m_sec.dec(localStorage.getItem('pol_witness_logs'));
    const savedCheck = _m_sec.dec(localStorage.getItem('pol_checklist_data'));

    if (savedName) setStoreName(savedName);
    if (savedAddr) setAddress(savedAddr);
    if (savedPhone) setGuardianPhone(savedPhone);
    if (savedLogs) setLogs(JSON.parse(savedLogs));
    
    if (savedCheck) {
      const parsed = JSON.parse(savedCheck);
      const today = new Date().toISOString().split('T')[0];
      if (parsed.date === today) {
        setChecklist(parsed.checks || []);
      } else {
        setChecklist(new Array(CHECKLIST_ITEMS.length).fill(false));
      }
    } else {
      setChecklist(new Array(CHECKLIST_ITEMS.length).fill(false));
    }

    if (!savedName) setIsSettingsOpen(true);
  }, []);

  // --- 설정 저장 (암호화) ---
  const saveSettings = () => {
    const nameInput = document.getElementById('inputStoreName').value.trim();
    const addrInput = document.getElementById('inputAddress').value.trim();
    const phoneInput = document.getElementById('inputGuardianPhone').value.trim();

    if (!nameInput || !addrInput) {
      alert("상호명과 주소는 필수입니다.");
      return;
    }

    localStorage.setItem('pol_storeName', _m_sec.enc(nameInput));
    localStorage.setItem('pol_address', _m_sec.enc(addrInput));
    localStorage.setItem('pol_guardianPhone', _m_sec.enc(phoneInput));

    setStoreName(nameInput);
    setAddress(addrInput);
    setGuardianPhone(phoneInput);
    setIsSettingsOpen(false);

    if (!localStorage.getItem('pol_guide_shown')) {
      setIsGuideOpen(true);
      localStorage.setItem('pol_guide_shown', 'true');
    }
  };

  // --- 긴급 신고 ---
  const sendEmergencySMS = () => {
    if (!storeName) { setIsSettingsOpen(true); return; }
    const message = `[긴급신고/상당경찰서] 위급상황 발생!\n장소: ${address}\n상호: ${storeName}\n즉시 출동 바랍니다.`;
    if (window.confirm("112 문자 신고창으로 이동하시겠습니까?")) {
      window.location.href = `sms:112?body=${encodeURIComponent(message)}`;
    }
  };

  const sendGuardianSMS = () => {
    if (!guardianPhone) { alert("설정에서 보호자 연락처를 등록해주세요."); setIsSettingsOpen(true); return; }
    const message = `[긴급연락] ${storeName}입니다. 지금 가게로 급히 와주세요. 도움이 필요합니다.`;
    if (window.confirm(`보호자(${guardianPhone})에게 문자를 보내시겠습니까?`)) {
      const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
      window.location.href = `sms:${guardianPhone}${isIOS ? '&' : '?'}body=${encodeURIComponent(message)}`;
    }
  };

  // --- 스마트 위트니스 (기록 암호화) ---
  const addTrait = (t) => {
    setCurrentTraits([...currentTraits, t]);
    alert(`'${t}' 선택됨. (현재: ${[...currentTraits, t].join(', ')})`);
  };

  const saveWitnessLog = () => {
    if (currentTraits.length === 0) { alert("특징을 선택해주세요."); return; }
    const now = new Date();
    const newLog = `${now.toLocaleDateString()} ${now.toLocaleTimeString()} - ${currentTraits.join(', ')}`;
    const updatedLogs = [newLog, ...logs].slice(0, 50);
    
    setLogs(updatedLogs);
    localStorage.setItem('pol_witness_logs', _m_sec.enc(JSON.stringify(updatedLogs)));
    setCurrentTraits([]);
    alert("저장되었습니다.");
  };

  const clearLogs = () => {
    if (window.confirm("기록을 모두 삭제하시겠습니까?")) {
      localStorage.removeItem('pol_witness_logs');
      setLogs([]);
    }
  };

  const copyLogs = () => {
    if (logs.length === 0) return;
    const text = "[상당 폴-매니저 기록]\n" + logs.join('\n');
    const el = document.createElement('textarea');
    el.value = text;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    alert("기록이 복사되었습니다.");
  };

  // --- 체크리스트 (상태 암호화) ---
  const toggleCheck = (idx) => {
    const updated = [...checklist];
    updated[idx] = !updated[idx];
    setChecklist(updated);
    const today = new Date().toISOString().split('T')[0];
    localStorage.setItem('pol_checklist_data', _m_sec.enc(JSON.stringify({ date: today, checks: updated })));
  };

  const progress = checklist.length ? Math.round((checklist.filter(Boolean).length / checklist.length) * 100) : 0;

  return (
    <div className="flex justify-center bg-gray-200 min-h-screen">
      <div className="w-full max-w-md bg-white min-h-screen flex flex-col shadow-2xl relative overflow-hidden">
        
        {/* 헤더 */}
        <header className="bg-[#1a237e] text-white p-4 flex items-center justify-between shadow-md z-20">
          <div className="flex items-center gap-3">
            <button onClick={() => window.location.href='../'} className="p-1 rounded-full hover:bg-blue-900 transition">
              <ArrowLeft size={24} />
            </button>
            <img src="logo.png" className="w-10 h-10 object-contain rounded-full bg-white p-0.5" 
                 onError={(e) => e.target.src='https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Emblem_of_the_Korean_National_Police_Agency.svg/150px-Emblem_of_the_Korean_National_Police_Agency.svg.png'} />
            <div>
              <h1 className="font-black text-lg leading-tight">폴-매니저</h1>
              <p className="text-[10px] text-gray-300">소상공인 안심 파트너</p>
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={() => setIsGuideOpen(true)} className="text-yellow-300 hover:text-white text-[10px] border border-yellow-300 rounded px-2 py-1 font-bold flex items-center gap-1">
              <SquarePlus size={12} />바로가기
            </button>
            <button onClick={() => setIsSettingsOpen(true)} className="text-gray-300 hover:text-white transition">
              <Settings size={22} />
            </button>
          </div>
        </header>

        {/* 메인 콘텐츠 */}
        <main className="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
          
          <div className="bg-blue-50 border-l-4 border-[#1a237e] p-4 rounded-r-lg shadow-sm">
            <p className="text-[10px] text-gray-500 mb-1">{currentDate}</p>
            <h2 className="text-lg font-bold text-gray-800 leading-tight">
              <span className="text-[#1a237e]">{storeName || "사장님"}</span>, <br />
              오늘도 안전하게 지켜드릴게요.
            </h2>
          </div>

          {/* 긴급 대응 */}
          <section className="space-y-3">
            <button onClick={sendEmergencySMS} className="w-full py-6 rounded-2xl bg-gradient-to-br from-red-600 to-red-700 text-white shadow-lg active:scale-95 transition-transform border-4 border-red-400 flex flex-col items-center justify-center gap-1">
              <Lightbulb size={32} className="animate-pulse" />
              <span className="text-xl font-black">112 긴급 문자 신고</span>
              <span className="text-[10px] opacity-80">위치+주소 자동 입력</span>
            </button>
            <button onClick={sendGuardianSMS} className="w-full py-3 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-xl shadow active:scale-95 transition flex items-center justify-center gap-2">
              <MessageSquare size={18} />
              <span>보호자(가족) 호출 문자</span>
              <span className="text-[10px] bg-yellow-600 text-white px-2 py-0.5 rounded-full">조용히</span>
            </button>
          </section>

          {/* 인상착의 기록 */}
          <section className="bg-white rounded-xl border-2 border-indigo-100 shadow-sm p-4">
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <Eye size={18} className="text-indigo-600" />수상한 사람 기록
              </h3>
              <span className="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold">수사 단서</span>
            </div>
            <div className="grid grid-cols-3 gap-2 mb-4">
              {['남성', '여성', '아는사람', '검정의상', '밝은의상', '마스크'].map(t => (
                <button key={t} onClick={() => addTrait(t)} className="bg-gray-50 py-2 rounded-lg text-xs font-bold border border-gray-100 text-gray-600 hover:bg-indigo-50 transition">
                  {t}
                </button>
              ))}
            </div>
            <button onClick={saveWitnessLog} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md mb-4 flex items-center justify-center gap-2 text-sm">
              <Save size={16} /> 지금 상황 저장하기
            </button>
            <div className="bg-gray-50 rounded-lg p-3">
              <div className="flex justify-between items-center mb-2 border-b pb-1">
                <span className="text-[10px] font-bold text-gray-500">최근 기록</span>
                <div className="flex gap-2">
                  <button onClick={clearLogs} className="text-[10px] text-red-500 underline font-medium flex items-center gap-1"><Trash2 size={10}/>삭제</button>
                  <button onClick={copyLogs} className="text-[10px] text-blue-600 underline font-medium flex items-center gap-1"><Copy size={10}/>복사</button>
                </div>
              </div>
              <ul className="space-y-1.5">
                {logs.length > 0 ? logs.slice(0, 3).map((log, i) => (
                  <li key={i} className="text-[11px] text-gray-700 bg-white p-2 rounded border border-gray-200 truncate">{log}</li>
                )) : <li className="text-[11px] text-gray-400 text-center py-2">기록이 없습니다.</li>}
              </ul>
            </div>
          </section>

          {/* 안전 점검 */}
          <section className="bg-white rounded-xl border border-gray-200 shadow-sm p-4">
            <div className="flex items-center justify-between mb-4">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <CheckCircle2 size={18} className="text-green-600" />퇴근 전 안전 점검
              </h3>
              <span className={`text-[10px] font-bold px-2 py-1 rounded ${progress === 100 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                {progress}% 완료
              </span>
            </div>
            <div className="space-y-2.5">
              {CHECKLIST_ITEMS.map((item, idx) => (
                <label key={idx} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition">
                  <input type="checkbox" checked={checklist[idx] || false} onChange={() => toggleCheck(idx)} className="w-5 h-5 accent-green-600 rounded" />
                  <span className="text-xs text-gray-700 font-medium">{item}</span>
                </label>
              ))}
            </div>
          </section>
        </main>

        <footer className="bg-gray-100 p-4 text-center border-t text-[10px] text-gray-400 pb-8">
          청주상당경찰서 범죄예방대응과<br />
          범죄신고 112 | 민원상담 182
        </footer>

        {/* 설정 모달 */}
        {isSettingsOpen && (
          <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-in zoom-in duration-200">
              <div className="bg-[#1a237e] p-4 text-white text-center">
                <h2 className="font-bold text-lg">정보 설정</h2>
                <p className="text-[10px] opacity-80">위급 상황 대비를 위한 기초 정보</p>
              </div>
              <div className="p-6 space-y-4">
                <div>
                  <label className="block text-xs font-bold text-gray-700 mb-1">상호명</label>
                  <input type="text" id="inputStoreName" defaultValue={storeName} placeholder="예: 상당헤어샵" className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 text-sm outline-none focus:border-indigo-500 transition" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-700 mb-1">매장 주소 (도로명)</label>
                  <textarea id="inputAddress" defaultValue={address} rows="2" placeholder="예: 상당구 1순환로 1234, 1층" className="w-full p-3 border border-gray-300 rounded-xl bg-gray-50 text-sm outline-none focus:border-indigo-500 transition"></textarea>
                </div>
                <div>
                  <label className="block text-xs font-bold text-indigo-700 mb-1 flex items-center gap-1"><Shield size={12} />보호자 연락처</label>
                  <input type="tel" id="inputGuardianPhone" defaultValue={guardianPhone} placeholder="예: 010-1234-5678" className="w-full p-3 border border-indigo-200 rounded-xl bg-indigo-50 text-sm outline-none focus:border-indigo-500 transition" />
                </div>
                <div className="pt-2 flex flex-col gap-2">
                  <button onClick={saveSettings} className="w-full bg-[#1a237e] text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">저장하기</button>
                  <button onClick={() => storeName && setIsSettingsOpen(false)} className="w-full text-gray-400 text-xs underline py-2">닫기</button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* 바로가기 가이드 모달 */}
        {isGuideOpen && (
          <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative animate-in fade-in zoom-in duration-300">
              <button onClick={() => setIsGuideOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><X size={24} /></button>
              <h2 className="text-xl font-bold text-gray-800 mb-2">홈 화면 바로가기 추가</h2>
              <p className="text-xs text-gray-500 mb-4 tracking-tight">바탕화면에 아이콘을 만들면 즉시 실행 가능합니다.</p>
              
              <div className="flex border-b mb-4">
                <button onClick={() => setGuideTab('android')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition ${guideTab === 'android' ? 'border-[#1a237e] text-[#1a237e]' : 'border-transparent text-gray-400'}`}>안드로이드</button>
                <button onClick={() => setGuideTab('ios')} className={`flex-1 py-2 text-sm font-bold border-b-2 transition ${guideTab === 'ios' ? 'border-[#1a237e] text-[#1a237e]' : 'border-transparent text-gray-400'}`}>아이폰</button>
              </div>

              <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 text-xs space-y-3 min-h-[140px] flex flex-col justify-center">
                {guideTab === 'android' ? (
                  <>
                    <div className="flex items-start gap-3">
                      <span className="bg-indigo-100 text-indigo-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 font-bold">1</span>
                      <p>브라우저 우측 상단 <b>더보기(점 3개)</b> <br />메뉴를 클릭합니다.</p>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="bg-indigo-100 text-indigo-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 font-bold">2</span>
                      <p><b>[홈 화면에 추가]</b> 항목을 선택합니다.</p>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="flex items-start gap-3">
                      <span className="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 font-bold">1</span>
                      <p>Safari 하단 중앙의 <b>공유(화살표)</b> <br />버튼을 클릭합니다.</p>
                    </div>
                    <div className="flex items-start gap-3">
                      <span className="bg-blue-100 text-blue-700 w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 font-bold">2</span>
                      <p><b>[홈 화면에 추가]</b>를 선택합니다.</p>
                    </div>
                  </>
                )}
              </div>
              
              <button onClick={() => setIsGuideOpen(false)} className="w-full bg-[#1a237e] text-white py-4 rounded-xl mt-4 font-bold shadow-lg active:scale-95 transition">확인</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default App;
