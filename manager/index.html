<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>상당 폴-매니저</title>
    
    <!-- [중요] 홈 화면 추가 시 아이콘 설정 (로고 적용) -->
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    
    <!-- PWA 메타 태그 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- 상태바 스타일 (어두운 배경에 흰 글씨) -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- 테마 색상 (경찰 남색 #1a237e) -->
    <meta name="theme-color" content="#1a237e">

    <!-- [성과분석] 구글 애널리틱스 (GA4) 연동 준비 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CPSKM0VVYP"></script>
    <script>
        const GA_MEASUREMENT_ID = 'G-CPSKM0VVYP'; 
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        gtag('js', new Date());
        gtag('config', GA_MEASUREMENT_ID, {
            'page_title': '상당 폴-매니저',
            'anonymize_ip': true 
        });

        function sendAnalyticsEvent(eventName, params = {}) {
            gtag('event', eventName, params);
        }
    </script>

    <!-- 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f3f4f6; touch-action: manipulation; }
        /* 경찰 고유의 짙은 남색 */
        .bg-police-dark { background-color: #1a237e; }
        .text-police-blue { color: #1a237e; }
        
        /* 긴급 버튼 펄스 애니메이션 */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }

        /* 체크박스 커스텀 */
        .custom-checkbox input:checked + div { background-color: #10b981; border-color: #10b981; }
        .custom-checkbox input:checked + div svg { display: block; }

        /* 기록 로그 등장 애니메이션 */
        .log-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-icon-wrapper i { font-size: 1.25rem; margin-bottom: 0.25rem; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center">

    <!-- 모바일 컨테이너 -->
    <div class="w-full max-w-md bg-white h-screen shadow-2xl flex flex-col relative overflow-hidden">
        
        <!-- 헤더 (원래의 경찰 남색 배경 복귀) -->
        <header class="bg-police-dark text-white p-4 flex items-center justify-between shadow-md z-10 pt-safe-top">
            <div class="flex items-center gap-3">
                <!-- 뒤로가기 버튼 -->
                <button onclick="location.href='../'" class="hover:bg-blue-900 p-1 rounded-full transition mr-1">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>

                <!-- 로고 이미지 -->
                <img src="logo.png" 
                     onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Emblem_of_the_Korean_National_Police_Agency.svg/150px-Emblem_of_the_Korean_National_Police_Agency.svg.png'"
                     alt="청주상당경찰서" 
                     class="w-10 h-10 object-contain rounded-full bg-white p-0.5 shadow-sm"> 
                
                <div>
                    <h1 class="font-black text-lg leading-tight">폴-매니저</h1>
                    <p class="text-xs text-gray-300">소상공인 안심 파트너</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <!-- 앱 설치 버튼 -->
                <button onclick="openInstallGuide()" class="text-yellow-300 hover:text-white text-xs border border-yellow-300 rounded px-2 py-1 transition font-bold">
                    <i class="fa-solid fa-download mr-1"></i>앱설치
                </button>
                <!-- 설정 버튼 -->
                <button onclick="openSettings()" class="text-gray-300 hover:text-white transition px-1">
                    <i class="fa-solid fa-gear text-xl"></i>
                </button>
            </div>
        </header>

        <!-- 메인 콘텐츠 -->
        <main class="flex-1 overflow-y-auto p-4 pb-24 space-y-6" id="mainContent">
            
            <!-- 상태 메시지 카드 -->
            <div class="bg-blue-50 border-l-4 border-police-blue p-4 rounded-r-lg shadow-sm">
                <p class="text-sm text-gray-600 mb-1" id="currentDate">날짜 로딩중...</p>
                <h2 class="text-xl font-bold text-gray-800">
                    <span id="displayStoreName" class="text-police-blue">사장님</span>, <br>
                    오늘도 안전하게 지켜드릴게요.
                </h2>
            </div>

            <!-- 1. [대응] 긴급 신고 & 보호자 호출 -->
            <section class="grid grid-cols-2 gap-4">
                <div class="col-span-2 text-center">
                    <button onclick="sendEmergencySMS()" 
                            class="w-full py-6 rounded-2xl bg-gradient-to-br from-red-600 to-red-700 text-white shadow-lg active:scale-95 transition-transform animate-pulse-red border-4 border-red-400 flex flex-col items-center justify-center gap-1">
                        <i class="fa-solid fa-lightbulb text-3xl mb-1"></i>
                        <span class="text-2xl font-black">112 긴급 문자 신고</span>
                        <span class="text-xs opacity-80 font-normal">위치+주소 자동 입력</span>
                    </button>
                </div>
                
                <div class="col-span-2">
                    <button onclick="sendGuardianSMS()" class="w-full py-3 bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold rounded-xl shadow active:scale-95 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-comment-sms text-xl"></i>
                        <span>보호자(가족) 호출 문자</span>
                        <span class="text-xs bg-yellow-600 text-white px-2 py-0.5 rounded-full">조용히</span>
                    </button>
                </div>
            </section>

            <!-- 2. [특수시책] 스마트 위트니스 (기록) -->
            <section class="bg-white rounded-xl border-2 border-indigo-100 shadow-lg p-4 relative overflow-hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                        <i class="fa-solid fa-eye text-indigo-600"></i>
                        수상한 사람 간편 기록
                    </h3>
                    <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-bold">수사 단서 확보용</span>
                </div>
                <p class="text-xs text-gray-500 mb-3">
                    기억이 사라지기 전에 터치하세요. 인상착의가 자동 저장됩니다.<br>
                    (스토킹 증거 활용)
                </p>

                <!-- 입력 버튼 그룹 -->
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button onclick="addLogTrait('남성')" class="bg-gray-50 py-3 rounded-lg text-sm hover:bg-blue-100 transition flex flex-col items-center btn-icon-wrapper text-gray-700 font-bold border border-gray-100">
                        <i class="fa-solid fa-person text-blue-600"></i>남성
                    </button>
                    <button onclick="addLogTrait('여성')" class="bg-gray-50 py-3 rounded-lg text-sm hover:bg-red-100 transition flex flex-col items-center btn-icon-wrapper text-gray-700 font-bold border border-gray-100">
                        <i class="fa-solid fa-person-dress text-red-500"></i>여성
                    </button>
                    <button onclick="addLogTrait('아는사람')" class="bg-gray-50 py-3 rounded-lg text-sm hover:bg-green-100 transition flex flex-col items-center btn-icon-wrapper text-gray-700 font-bold border border-gray-100">
                        <i class="fa-solid fa-user-group text-green-600"></i>아는사람
                    </button>
                    
                    <button onclick="addLogTrait('검정/어두운 옷')" class="bg-gray-800 text-white py-3 rounded-lg text-sm hover:bg-gray-900 transition flex flex-col items-center btn-icon-wrapper font-bold shadow-sm">
                        <i class="fa-solid fa-shirt"></i>검정/어두움
                    </button>
                    <button onclick="addLogTrait('흰색/밝은 옷')" class="bg-white text-gray-700 border border-gray-300 py-3 rounded-lg text-sm hover:bg-gray-50 transition flex flex-col items-center btn-icon-wrapper font-bold shadow-sm">
                        <i class="fa-solid fa-shirt text-gray-400"></i>흰색/밝음
                    </button>
                    <button onclick="addLogTrait('모자/마스크')" class="bg-gray-50 py-3 rounded-lg text-sm hover:bg-gray-200 transition flex flex-col items-center btn-icon-wrapper text-gray-700 font-bold border border-gray-100">
                        <i class="fa-solid fa-mask text-gray-600"></i>모자/마스크
                    </button>

                    <button onclick="addLogTrait('주취소란')" class="bg-red-50 text-red-600 py-3 rounded-lg text-sm font-bold border border-red-100 hover:bg-red-100 transition flex flex-col items-center btn-icon-wrapper">
                        <i class="fa-solid fa-beer-mug-empty"></i>술주정
                    </button>
                    <button onclick="addLogTrait('욕설/위협')" class="bg-red-50 text-red-600 py-3 rounded-lg text-sm font-bold border border-red-100 hover:bg-red-100 transition flex flex-col items-center btn-icon-wrapper">
                        <i class="fa-solid fa-face-angry"></i>욕설/위협
                    </button>
                    <button onclick="addLogTrait('스토킹/염탐')" class="bg-purple-50 text-purple-600 py-3 rounded-lg text-sm font-bold border border-purple-100 hover:bg-purple-100 transition flex flex-col items-center btn-icon-wrapper">
                        <i class="fa-solid fa-eye"></i>훔쳐봄
                    </button>
                </div>

                <!-- 저장 버튼 -->
                <button onclick="saveLog()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md active:scale-95 transition mb-4 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-floppy-disk"></i> 지금 상황 저장하기
                </button>

                <!-- 기록 리스트 -->
                <div class="bg-gray-50 rounded-lg p-3 min-h-[80px]">
                    <div class="flex justify-between items-center mb-2 border-b pb-1">
                        <span class="text-xs font-bold text-gray-500">최근 기록</span>
                        <div class="flex gap-2">
                            <button onclick="clearLogs()" class="text-xs text-red-500 hover:text-red-700 underline font-medium">
                                <i class="fa-solid fa-trash-can mr-1"></i>삭제
                            </button>
                            <button onclick="copyLogs()" class="text-xs text-blue-600 hover:text-blue-800 underline font-medium">
                                <i class="fa-regular fa-copy mr-1"></i>복사
                            </button>
                        </div>
                    </div>
                    <ul id="logList" class="text-xs space-y-2 text-gray-700">
                        <li class="text-center text-gray-400 py-2">기록된 내용이 없습니다.</li>
                    </ul>
                </div>
            </section>

            <!-- 3. [습관] 안전 마감 체크리스트 -->
            <section class="bg-white rounded-xl border border-gray-200 shadow-sm p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check text-green-600"></i>
                        퇴근 전 안전 점검
                    </h3>
                    <span id="progressText" class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">0% 완료</span>
                </div>
                <div class="space-y-3" id="checklistContainer"></div>
                <div id="completeMessage" class="hidden mt-4 p-3 bg-green-50 rounded-lg border border-green-200 text-center animate-bounce">
                    <i class="fa-solid fa-circle-check text-green-600 text-2xl mb-1"></i>
                    <p class="font-bold text-green-800">오늘 하루도 고생하셨습니다!</p>
                </div>
            </section>
        </main>

        <footer class="bg-gray-100 p-3 text-center border-t text-xs text-gray-500 pb-8">
            <p>청주상당경찰서 범죄예방대응과</p>
            <p class="mt-1">범죄신고 112  민원상담 182</p>
        </footer>

        <!-- 설정 모달 (버튼 위치 및 디자인 수정됨) -->
        <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4 modal">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
                <div class="bg-police-dark p-4 text-white text-center flex-shrink-0">
                    <h2 class="font-bold text-lg">설정</h2>
                    <p class="text-xs opacity-80">위급 시 전송될 정보를 입력해주세요.</p>
                </div>
                <div class="p-6 space-y-4 overflow-y-auto">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">상호명</label>
                        <input type="text" id="inputStoreName" placeholder="예: 상당헤어샵" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">정확한 위치 (도로명 + 상세)</label>
                        <textarea id="inputAddress" rows="2" placeholder="예: 상당구 1순환로 1234, 1층" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50"></textarea>
                    </div>
                    <div class="border-t pt-4 mt-4">
                        <label class="block text-sm font-bold text-blue-800 mb-1"><i class="fa-solid fa-user-shield mr-1"></i>보호자 연락처 (선택)</label>
                        <input type="tel" id="inputGuardianPhone" placeholder="예: 010-1234-5678" class="w-full p-3 border border-blue-200 rounded-lg bg-blue-50 focus:ring-blue-500">
                    </div>
                    
                    <!-- 버튼 영역 명확하게 분리 -->
                    <div class="pt-2 flex flex-col gap-2">
                        <button onclick="saveSettings()" class="w-full bg-police-dark text-white font-bold py-3 rounded-lg shadow-md hover:bg-opacity-90 transition">
                            저장하기
                        </button>
                        <button onclick="closeSettingsIfDataExists()" class="w-full text-gray-500 py-2 text-sm underline hover:text-gray-800">
                            닫기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 앱 설치 가이드 (탭 기능 추가) -->
        <div id="installGuideModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden flex flex-col items-center justify-center p-6 modal">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 relative">
                <button onclick="closeInstallGuide()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
                <h2 class="text-xl font-bold text-gray-800 mb-2">앱 아이콘 만들기</h2>
                <p class="text-sm text-gray-600 mb-4">홈 화면에 추가하면 QR코드 없이 바로 실행됩니다.</p>
                
                <!-- 탭 버튼 -->
                <div class="flex border-b mb-3">
                    <button id="btnAndroid" onclick="showGuide('android')" class="flex-1 py-2 text-sm font-bold border-b-2 border-police-blue text-police-blue transition">안드로이드</button>
                    <button id="btnIos" onclick="showGuide('ios')" class="flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition">아이폰</button>
                </div>

                <!-- 아이폰용 (기본 숨김) -->
                <div id="iosGuide" class="hidden bg-gray-50 p-3 rounded-lg border mb-2 text-sm space-y-2 min-h-[100px]">
                    <p class="font-bold text-gray-800 border-b pb-1 mb-1">아이폰 (Safari)</p>
                    <div>1. 브라우저 하단 중앙의 <b class="text-blue-600"><i class="fa-solid fa-arrow-up-from-bracket"></i> 공유</b> 버튼 클릭</div>
                    <div>2. 메뉴를 위로 올려 <b class="text-gray-800"><i class="fa-regular fa-square-plus"></i> 홈 화면에 추가</b> 선택</div>
                    <div>3. 우측 상단 <b>추가</b> 버튼 클릭</div>
                </div>
                
                <!-- 안드로이드용 (기본 표시) -->
                <div id="androidGuide" class="bg-gray-50 p-3 rounded-lg border mb-2 text-sm space-y-2 min-h-[100px]">
                    <p class="font-bold text-gray-800 border-b pb-1 mb-1">안드로이드 (Chrome/Samsung)</p>
                    <div>1. <b>현재 보고 계신 인터넷 창</b>의 우측 상단(또는 하단) <b class="text-gray-800"><i class="fa-solid fa-ellipsis-vertical"></i> 점 3개</b> 메뉴 클릭</div>
                    <div class="text-xs text-gray-500">※ 파란색 앱 헤더가 아닌, 인터넷 창 테두리에 있습니다.</div>
                    <div>2. <b class="text-gray-800"><i class="fa-solid fa-mobile-screen"></i> 홈 화면에 추가</b> (또는 앱 설치) 선택</div>
                </div>
                
                <button onclick="closeInstallGuide()" class="w-full bg-police-blue text-white py-2 rounded-lg mt-4 font-bold">확인</button>
            </div>
        </div>

    </div>

    <script>
        // === 1. 설정 및 초기화 ===
        const CHECKLIST_ITEMS = [
            "출입문 시정장치 및 경보음 작동 확인",
            "CCTV 녹화 상태 및 카메라 각도 점검",
            "현금·귀금속 시재 금고 보관 및 잠금 확인",
            "가게 내·외부 사각지대 확인",
            "가스/전기 차단 및 소등 확인"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadDate();
            checkFirstTimeUser();
            renderChecklist();
            loadChecklistState();
            loadWitnessLogs(); // 기록 불러오기
            
            // 통계: 첫 방문 시 이벤트 전송
            sendAnalyticsEvent('app_open', { date: new Date().toISOString() });
        });

        function loadDate() {
            const now = new Date();
            document.getElementById('currentDate').innerText = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
        }

        // === 2. 설정 관리 ===
        function checkFirstTimeUser() {
            const storeName = localStorage.getItem('pol_storeName');
            if (!storeName) openSettings();
            else document.getElementById('displayStoreName').innerText = storeName;
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('inputStoreName').value = localStorage.getItem('pol_storeName') || '';
            document.getElementById('inputAddress').value = localStorage.getItem('pol_address') || '';
            document.getElementById('inputGuardianPhone').value = localStorage.getItem('pol_guardianPhone') || '';
        }

        function closeSettingsIfDataExists() {
            if(localStorage.getItem('pol_storeName')) document.getElementById('settingsModal').classList.add('hidden');
            else alert("기본 정보를 입력해주세요.");
        }

        function saveSettings() {
            const name = document.getElementById('inputStoreName').value.trim();
            const addr = document.getElementById('inputAddress').value.trim();
            const guardian = document.getElementById('inputGuardianPhone').value.trim();

            if (!name || !addr) { alert("상호명과 주소는 필수입니다."); return; }

            localStorage.setItem('pol_storeName', name);
            localStorage.setItem('pol_address', addr);
            localStorage.setItem('pol_guardianPhone', guardian);

            document.getElementById('displayStoreName').innerText = name;
            document.getElementById('settingsModal').classList.add('hidden');
            
            // 통계: 설정 저장 이벤트
            sendAnalyticsEvent('setting_saved', { store_name: name });
            
            setTimeout(() => { if(!localStorage.getItem('pol_guide_shown')) openInstallGuide(); }, 500);
        }

        // === 3. 긴급 문자 기능 ===
        function sendEmergencySMS() {
            const storeName = localStorage.getItem('pol_storeName');
            const address = localStorage.getItem('pol_address');
            if (!storeName) { openSettings(); return; }

            const message = `[긴급신고/상당경찰서] 위급상황 발생!\n장소: ${address}\n상호: ${storeName}\n즉시 출동 바랍니다.`;
            if(confirm("112 문자 신고창으로 이동하시겠습니까?")) {
                // 통계: 112 신고 버튼 클릭 (가장 중요)
                sendAnalyticsEvent('click_112_emergency');
                window.location.href = `sms:112?body=${encodeURIComponent(message)}`;
            }
        }

        function sendGuardianSMS() {
            const guardianPhone = localStorage.getItem('pol_guardianPhone');
            const storeName = localStorage.getItem('pol_storeName');
            if (!guardianPhone) { alert("설정에서 보호자 연락처를 등록해주세요."); openSettings(); return; }
            
            const message = `[긴급연락] ${storeName}입니다. 지금 가게로 급히 와주세요. 도움이 필요합니다.`;
            if(confirm(`보호자(${guardianPhone})에게 문자를 보내시겠습니까?`)) {
                // 통계: 보호자 호출 클릭
                sendAnalyticsEvent('click_guardian_call');
                
                const userAgent = navigator.userAgent.toLowerCase();
                let separator = (userAgent.indexOf("iphone") > -1 || userAgent.indexOf("ipad") > -1) ? "&" : "?";
                window.location.href = `sms:${guardianPhone}${separator}body=${encodeURIComponent(message)}`;
            }
        }

        // === 4. [특수시책] 스마트 위트니스 (기록) ===
        let currentTraits = [];

        function addLogTrait(trait) {
            currentTraits.push(trait);
            // 버튼 눌렀다는 피드백 (토스트 메시지 대용)
            alert(`'${trait}' 선택됨. (현재: ${currentTraits.join(', ')})`);
        }

        function saveLog() {
            if (currentTraits.length === 0) {
                alert("선택된 특징이 없습니다. 버튼을 눌러 특징을 입력해주세요.");
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleDateString() + " " + now.toLocaleTimeString();
            const logContent = `${timeString} - ${currentTraits.join(', ')}`;
            
            // 로컬 스토리지에 저장
            let logs = JSON.parse(localStorage.getItem('pol_witness_logs') || '[]');
            logs.unshift(logContent); // 최신순
            if(logs.length > 50) logs.pop(); // 최대 50개 유지
            localStorage.setItem('pol_witness_logs', JSON.stringify(logs));

            // 통계: 증거 기록 저장
            sendAnalyticsEvent('witness_log_saved', { traits_count: currentTraits.length });

            currentTraits = []; // 초기화
            loadWitnessLogs(); // 화면 갱신
            alert("저장되었습니다. 나중에 증거자료로 활용하세요.");
        }

        function loadWitnessLogs() {
            const logs = JSON.parse(localStorage.getItem('pol_witness_logs') || '[]');
            const listEl = document.getElementById('logList');
            listEl.innerHTML = '';

            if (logs.length === 0) {
                listEl.innerHTML = '<li class="text-center text-gray-400 py-2">기록된 내용이 없습니다.</li>';
                return;
            }

            // 최근 3개만 표시
            logs.slice(0, 3).forEach(log => {
                const li = document.createElement('li');
                li.className = 'log-item bg-white p-2 rounded border border-gray-200';
                li.innerText = log;
                listEl.appendChild(li);
            });
        }

        function copyLogs() {
            const logs = JSON.parse(localStorage.getItem('pol_witness_logs') || '[]');
            if (logs.length === 0) {
                alert("복사할 기록이 없습니다.");
                return;
            }
            const textToCopy = "[상당 폴-매니저 기록]\n" + logs.join('\n');
            
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("기록이 복사되었습니다. 경찰관이나 문자에 붙여넣으세요.");
            } catch (err) {
                console.error('복사 실패', err);
            }
            document.body.removeChild(textArea);
        }

        // 기록 삭제 기능 추가
        function clearLogs() {
            if(confirm("저장된 인상착의 기록을 모두 삭제하시겠습니까?")) {
                localStorage.removeItem('pol_witness_logs');
                loadWitnessLogs();
                alert("모든 기록이 삭제되었습니다.");
            }
        }


        // === 5. 체크리스트 & 가이드 로직 ===
        function renderChecklist() {
            const container = document.getElementById('checklistContainer');
            container.innerHTML = '';
            CHECKLIST_ITEMS.forEach((item, index) => {
                const id = `check-${index}`;
                container.innerHTML += `
                    <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition custom-checkbox">
                        <div class="relative">
                            <input type="checkbox" id="${id}" class="peer sr-only" onchange="updateChecklistState()">
                            <div class="w-6 h-6 border-2 border-gray-300 rounded bg-white transition flex items-center justify-center">
                                <svg class="w-4 h-4 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                            </div>
                        </div>
                        <span class="text-gray-700 text-sm font-medium select-none">${item}</span>
                    </label>`;
            });
        }

        function updateChecklistState() {
            const checkboxes = document.querySelectorAll('#checklistContainer input[type="checkbox"]');
            let checkedCount = 0;
            const stateArray = [];
            checkboxes.forEach(cb => { if(cb.checked) checkedCount++; stateArray.push(cb.checked); });

            const percentage = Math.round((checkedCount / checkboxes.length) * 100);
            const progressText = document.getElementById('progressText');
            progressText.innerText = `${percentage}% 완료`;
            
            const isComplete = percentage === 100;
            if (isComplete) {
                // 통계: 체크리스트 완료
                sendAnalyticsEvent('checklist_completed');
            }

            progressText.className = `text-xs font-bold px-2 py-1 rounded ${isComplete ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`;
            document.getElementById('completeMessage').classList.toggle('hidden', !isComplete);

            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('pol_checklist_data', JSON.stringify({ date: today, checks: stateArray }));
        }

        function loadChecklistState() {
            const savedData = localStorage.getItem('pol_checklist_data');
            if (!savedData) return;
            const parsedData = JSON.parse(savedData);
            if (parsedData.date !== new Date().toISOString().split('T')[0]) { localStorage.removeItem('pol_checklist_data'); return; }
            const checkboxes = document.querySelectorAll('#checklistContainer input[type="checkbox"]');
            if (parsedData.checks) parsedData.checks.forEach((val, idx) => { if(checkboxes[idx]) checkboxes[idx].checked = val; });
            updateChecklistState();
        }

        // 가이드 로직 (탭 기능으로 업그레이드)
        function openInstallGuide() {
            const isIOS = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
            document.getElementById('installGuideModal').classList.remove('hidden');
            
            // OS 자동 감지하여 해당 탭 먼저 보여주기
            if (isIOS) showGuide('ios');
            else showGuide('android');
            
            localStorage.setItem('pol_guide_shown', 'true');
        }

        function closeInstallGuide() { 
            document.getElementById('installGuideModal').classList.add('hidden'); 
        }

        function showGuide(os) {
            const androidGuide = document.getElementById('androidGuide');
            const iosGuide = document.getElementById('iosGuide');
            const btnAndroid = document.getElementById('btnAndroid');
            const btnIos = document.getElementById('btnIos');

            if (os === 'android') {
                androidGuide.classList.remove('hidden');
                iosGuide.classList.add('hidden');
                
                btnAndroid.className = "flex-1 py-2 text-sm font-bold border-b-2 border-police-blue text-police-blue transition";
                btnIos.className = "flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition";
            } else {
                androidGuide.classList.add('hidden');
                iosGuide.classList.remove('hidden');
                
                btnIos.className = "flex-1 py-2 text-sm font-bold border-b-2 border-police-blue text-police-blue transition";
                btnAndroid.className = "flex-1 py-2 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition";
            }
        }
    </script>
</body>
</html>
